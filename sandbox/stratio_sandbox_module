#!/bin/sh
<<<<<<< HEAD
echo "> Installing maven"
wget apache.rediris.es/maven/maven-3/3.3.3/binaries/apache-maven-3.3.3-bin.tar.gz
cd /module
tar -xzf apache-maven-3.3.3-bin.tar.gz -C /opt/sds
echo "export M2_HOME=/opt/sds/apache-maven-3.3.3" >> /home/vagrant/.bashrc
source ~/.bashrc
echo "export PATH=/opt/sds/apache-maven-3.3.3/bin:/usr/local/sbin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin" >> /home/vagrant/.bashrc

echo "> Starting MongoDB"
echo "smallfiles=true" >> /etc/mongod.conf
/sbin/service mongod start

echo "> Starting ElasticSearch"
/sbin/service elasticsearch start
echo "http.cors.enabled: true" >> /etc/sds/elasticsearch/elasticsearch.yml
/opt/sds/elasticsearch/bin/./plugin -install royrusso/elasticsearch-HQ
/opt/sds/elasticsearch/bin/./plugin -install mobz/elasticsearch-head

rm -f /etc/udev/rules.d/70-persistent-net.rules
=======
STRATIO_ENV=$1
STRATIO_MODULE="crossdata ova"
STRATIO_MODULE_VERSION="1.0.1"
ipaddress=$(ip -4 addr show dev eth0 | grep inet | sed 's/^ *//g' | cut -d' ' -f 2 | cut -d'/' -f1)

#######################################
## SERVICES
#######################################

#######################################
## Cassandra
#######################################
>>>>>>> upstream/master

echo "Installing Cassandra..."
rpm --quiet -q stratio-cassandra || yum -y -q --nogpgcheck install stratio-cassandra

echo "Configuring Cassandra..."
##Config Cassandra:
sed -i "s/^\(num_tokens:\)/#\1/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^# \(initial_token:\)/\1/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^\(hinted_handoff_enabled:\) true$/\1 false/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^\(concurrent_reads:\) 32$/\1 16/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^\(concurrent_writes:\) 32$/\1 8/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^\(concurrent_counter_writes:\) 32$/\1 16/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/\(seeds:\) \"127.0.0.1\"/\1 \"$ipaddress\"/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^\(listen_address:\).*$/\1 $ipaddress/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^\(rpc_address:\).*$/\1 0.0.0.0/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^# \(broadcast_rpc_address:\).*$/\1 $ipaddress/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/\(\-Dcassandra.logdir=\)\$CASSANDRA_HOME\/logs/\1\/var\/log\/sds\/cassandra/" /opt/sds/cassandra/bin/cassandra

echo "> Installing Crossdata"
/usr/bin/yum -y install stratio-crossdata
/sbin/chkconfig --add crossdata
/sbin/chkconfig  crossdata on
/sbin/chkconfig --list
service crossdata start

cd /opt/sds/crossdats/server/lib
wget http://sodio.stratio.com/nexus/service/local/artifact/maven/redirect?r=releases&g=com.stratio.crossdata&a=crossdata-driver&v=

/usr/bin/yum -y install stratio-crossdata-driver

yum clean all
dd if=/dev/zero of=/EMPTY bs=1M
rm -f /EMPTY
